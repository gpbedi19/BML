var myApp=angular.module("myApp",["ngRoute","ngAnimate","myApp.SharedServices","ui.bootstrap","rzModule"]).config(["$routeProvider","$locationProvider",function(a,f){a.when("/index",{templateUrl:"./Partials/home.a"});a.when("/login",{templateUrl:"./Partials/login.a"});a.when("/register",{templateUrl:"./Partials/register.a"});a.when("/user/:pid",{templateUrl:"./Partials/register.a"});a.when("/invoice/:bid",{templateUrl:"./Partials/invoice.a"});a.when("/profile",{templateUrl:"./Partials/profile.a"});
a.when("/profile/:id",{templateUrl:"./Partials/profile.a"});a.when("/booking/:lab/:bid",{templateUrl:function(a){return"./Partials/"+a.lab+".a"}});a.when("/booking/:lab",{templateUrl:function(a){return"./Partials/"+a.lab+".a"}});a.when("/searchBooking",{templateUrl:function(a){return"./Partials/searchBooking.a"}});a.when("/logout",{templateUrl:"./App/logout.a",controller:"DummyCtrl"});a.otherwise({redirectTo:"/index"});f.html5Mode(!1)}]);myApp.controller("DummyCtrl",["$scope",function(a){}]);
var C={log:function(a){"localhost"===window.location.hostname&&console.debug(a)}};var sharedMod=angular.module("myApp.SharedServices",[]);
sharedMod.config(["$httpProvider",function(a){a.interceptors.push(["$q","$rootScope",function(a,g){return{request:function(a){$("#ajax-waiting").addClass("animate-text");$("#ajax-loader").show();return a},requestError:function(d){$("#ajax-waiting").removeClass("animate-text");$("#ajax-loader").hide();return a.reject(d)},response:function(a){$("#ajax-waiting").removeClass("animate-text");$("#ajax-loader").hide();g.$broadcast("ClearMessages",[]);return a},responseError:function(d){$("#ajax-waiting").removeClass("animate-text");
$("#ajax-loader").hide();C.log("Error occurred: >>>>>> "+JSON.stringify(d));return a.reject(d)}}}])}]);
sharedMod.factory("Shared",["$http","$location","$route","$filter",function(a,f,g,d){var c={User:{loggedIn:!1},SD:[],RT:[],RP:[],loginTooltip:function(a){return c.User.loggedIn?void 0:a},hasRole:function(a){var b=!1;0===c.User.roleList.length&&c.User.roleList.push({role:"USER"});for(var h=0;h<c.User.roleList.length;h++)if(c.User.roleList[h].role===a){b=!0;break}C.log("Shared.hasRole :: User "+(b?"has ":"does not have ")+a+" role.");return b},requireLogin:function(){a.get("./App/isLoggedIn.a").success(function(a,
b,h,k){!0===a.Payload?(c.User.loggedIn=!0,C.log("User is logged in. ")):(f.path("/Non-existent"),C.log("User is not logged in. "))}).error(function(a,b,h,c){a="Shared.requireLogin(): Error occurred: "+JSON.stringify(a);C.log(a)})},init:function(){C.log("Shared.init().");a.get("./App/getSessionDetails.a").success(function(a,b,h,k){"OK"===a.Status&&(c.User=a.Payload,c.User.loggedIn=!0);g.reload();C.log("Shared.init(): Loaded User: "+JSON.stringify(a.Payload))}).error(function(a,b,c,k){a="Shared.init(): Error occurred. Could not load session details. "+
JSON.stringify(a);C.log(a)});a.get("./App/getStaticData.a").success(function(a,b,h,k){if("OK"===a.Status)for(c.SD={},b=0;b<a.Payload.length;b++)c.SD[a.Payload[b].dataKey]=a.Payload[b].dataValues;C.log("Shared.init(): Loaded static data: "+JSON.stringify(c.SD))}).error(function(a,b,c,k){a="Shared.init(): Error occurred. Could not load static data. "+JSON.stringify(a);C.log(a)});a.get("./App/getResourceTypes.a").success(function(a,b,h,k){"OK"===a.Status&&(c.RT=a.Payload);C.log("Shared.init(): Loaded resource types: "+
JSON.stringify(c.RT))}).error(function(a,b,c,k){a="Shared.init(): Error occurred. Could not load resource types. "+JSON.stringify(a);C.log(a)});a.get("./App/getResourcePrices.a").success(function(a,b,h,k){"OK"===a.Status&&(c.RP=a.Payload);C.log("Shared.init(): Loaded resource prices: "+JSON.stringify(c.RP))}).error(function(a,b,c,k){a="Shared.init(): Error occurred. Could not load resource prices. "+JSON.stringify(a);C.log(a)})}};return c}]);
sharedMod.directive("uppercase",function(){return{require:"ngModel",link:function(a,f,g,d){f=function(a){if(void 0!==a){var e=a.toUpperCase();a!==e&&(d.$setViewValue(e),d.$render());return e}};d.$parsers.push(f);f(a[g.ngModel])}}});sharedMod.directive("dateinput",["$filter",function(a){return{require:"^ngModel",restrict:"A",link:function(f,g,d,c){c.$formatters.push(function(e){return e?a("date")(e,"dd/MM/yyyy"):""});c.$parsers.push(function(e){return a("date")(e,"dd/MM/yyyy")})}}}]);
sharedMod.directive("currencyInput",["$filter",function(a){return{require:"^ngModel",restrict:"A",link:function(f,g,d,c){c.$formatters.unshift(function(e){return e?a("currency")(e):""})}}}]);sharedMod.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(a,f,g,d){d.$validators.compareTo=function(c){return c===a.otherModelValue};a.$watch("otherModelValue",function(){d.$validate()})}}});myApp.controller("LoginCtrl",["$scope","$http","$location","Shared",function(a,f,g,d){a.Shared=d;a.LF={};C.log("LoginCtrl loaded.");a.login=function(){void 0===a.LF.email?a.setStatus("Please supply a valid email to login!"):f.post("./App/login.a",a.LF).success(function(c,e,b,h){"OK"===c.Status?(d.init(),g.path("/Non-exitent").replace()):a.setStatus(c.Payload)}).error(function(c,e,b,h){a.setStatus(c.Payload)})}}]);
myApp.controller("UserCtrl",["$scope","$http","$location","$routeParams","$route","Shared",function(a,f,g,d,c,e){a.Shared=e;a.Reg={};C.log("UserCtrl ...");var b=void 0!==d.pid,h=b?"./App/saveUser.a":"./App/register.a";b?(C.log("Editing user"),a.Reg=e.User):C.log("Creating new user.");a.saveUser=function(){f.post(h,a.Reg).success(function(c,h,d,f){"OK"===c.Status?b?(C.log("Updated user."),a.setStatus("Updated user details!")):(e.init(),g.path("/Non-exitent").replace()):a.setStatus(c.Payload)}).error(function(b,
e,c,h){a.setStatus(b.Payload)})}}]);
myApp.controller("IndexCtrl",["$scope","$http","$location","$q","Shared",function(a,f,g,d,c){C.log("IndexCtrl...");a.RootModel={Data:{}};a.Shared=c;a.setStatus=function(e){a.StatusMessage=e;$("#statusmsg").fadeIn(400)};a.hideStatus=function(){a.StatusMessage=void 0;$("#statusmsg").fadeOut(400)};a.logout=function(){f.get("./App/logout.a").success(function(a){C.log("Logged out: "+JSON.stringify(a));c.User={loggedIn:!1};g.path("/Non-exitent").replace()})};a.$on("Errors",function(c,b){a.Errors=b;a.Invalid=
0<b.length;C.log("Got errors: "+JSON.stringify(b)+". Invalid="+a.Invalid);a.setStatus("Your request could not be processed. Error occurred.")});a.$on("ClearMessages",function(c,b){a.Errors=[];a.Invalid=!1;a.hideStatus()});c.init();C.log("IndexCtrl: Loaded.");a.printableProfileDetails=function(a){if(void 0!==a.profile){var b=a.profile;a=""+b.designation+", Dept. "+b.dept+", ";a=a+b.org+" ("+b.orgType+"), "+b.address+" ";a=a+b.city+" "+b.state+" "+b.postalCode;a=a+". Ph. "+b.officePhone}else a="(Profile details missing.)";
return a}}]);myApp.controller("HomeCtrl",["$scope","$http","$routeParams","Shared",function(a,f,g,d){C.log("HomeCtrl: "+JSON.stringify(g));d.User.loggedIn&&f.get("./App/getDashboard.a").success(function(c,e,b,h){"OK"===c.Status?a.P=c.Payload:a.setStatus(c.Payload)}).error(function(c,e,b,h){a.setStatus(c.Payload)});a.markUserVerified=function(c){f.get("./App/markUserVerified.a?email="+c.email).success(function(e,b,h,d){"OK"===e.Status?c.verified=!0:a.setStatus(e.Payload)}).error(function(c,b,h,d){a.setStatus(c.Payload)})}}]);
myApp.controller("ProfileCtrl",["$scope","$http","$routeParams","Shared",function(a,f,g,d){C.log("ProfileCtrl: "+JSON.stringify(g));a.Shared=d;a.P={};f.get("./App/getProfile.a").success(function(c,e,b,h){"OK"===c.Status?a.P=c.Payload:a.setStatus(c.Payload)}).error(function(c,e,b,h){a.setStatus(c.Payload)});a.saveProfile=function(){f.post("./App/saveProfile.a",a.P).success(function(c,e,b,h){"OK"===c.Status?(a.P=c.Payload,a.setStatus("Saved user profile!")):a.setStatus(c.Payload)}).error(function(c,
e,b,h){a.setStatus(c.Payload)})}}]);myApp.controller("AdminCtrl",["$scope","$http","$routeParams","Shared",function(a,f,g,d){C.log("AdminCtrl: "+JSON.stringify(g));a.Shared=d;f.get("./App/getDashboard.a").success(function(c,e,b,h){"OK"===c.Status?a.P=c.Payload:a.setStatus(c.Payload)}).error(function(c,e,b,h){a.setStatus(c.Payload)})}]);myApp.controller("BookingSearchCtrl",["$scope","$http","$routeParams","Shared","$filter","$location",function(a,f,g,d,c,e){C.log("BookingSearchCtrl: "+JSON.stringify(g));a.Shared=d;a.P={results:[]};a.popup1={opened:!1};a.popup2={opened:!1};a.open1=function(){a.popup1.opened=!0};a.open2=function(){a.popup2.opened=!0};a.predicate="bookingDate";a.reverse=!0;a.order=function(b){a.reverse=a.predicate===b?!a.reverse:!1;a.predicate=b};a.showBooking=function(a){e.path("/spm/"+a+"/true")};a.search=function(){C.log("Searching: "+
JSON.stringify(a.P));a.P.bookingDateFrom=c("date")(a.P.bookingDateFrom,"mediumDate");a.P.bookingDateTo=c("date")(a.P.bookingDateTo,"mediumDate");f.post("./Bookings/searchBooking.a",a.P).success(function(b,c,e,d){"OK"===b.Status?a.P.results=b.Payload:a.setStatus(b.Payload)}).error(function(b,c,e,d){a.setStatus(b.Payload)})}}]);
myApp.controller("LabBookingCtrl",["$scope","$http","$routeParams","Shared","$filter","$location",function(a,f,g,d,c,e){C.log("LabBookingCtrl: "+JSON.stringify(g));a.Shared=d;a.P={booking:{bookingDate:c("date")(new Date,"mediumDate"),lab:g.lab,analysisModes:[],status:"PENDING"}};var b="./Bookings/getBooking.a?lab="+g.lab;void 0!==g.bid&&(b=b+"&bid="+g.bid,f.get(b).success(function(b,c,e,d){"OK"===b.Status?(a.P=b.Payload,a.P.booking.instrumentDate=new Date(a.P.booking.instrumentDate),a.calcTotalCharges(),
a.$broadcast("bookingLoaded",a.P.booking)):a.setStatus(b.Payload)}).error(function(b,c,e,d){a.setStatus(b.Payload)}));a.saveBooking=function(){a.P.inError?a.setStatus("Something seems wrong with details you entered! Please check."):(a.P.booking.instrumentDate=c("date")(a.P.booking.instrumentDate,"mediumDate"),f.post("./Bookings/saveBooking.a",a.P).success(function(b,c,d,f){"OK"===b.Status?(a.P=b.Payload,a.P.booking.instrumentDate=new Date(a.P.booking.instrumentDate),a.setStatus("Saved booking request!"),
e.path("/booking/"+g.lab+"/"+a.P.booking.bookingId).replace()):a.setStatus(b.Payload)}).error(function(b,c,e,d){a.setStatus(b.Payload)}))};a.calcCharges=function(b){if(void 0===b.resourceType)a.setStatus("Please select the resource type!");else{var c=d.RP.find(function(a){return a.resourceType.code===b.resourceType.code});void 0!==c?b.charges=b.samples*c.perSamplePrice+b.results*c.perResultPrice:a.setStatus("Pricing information could not be found for "+b.resourceType.code);a.calcTotalCharges();C.log(">>>>>>> "+
JSON.stringify(b))}};a.calcTotalCharges=function(){for(var b=a.P.booking.analysisModes,c=0,e=0;e<b.length;e++)c+=b[e].charges;a.totalCharges=c};a.removeAM=function(b){b=a.P.booking.analysisModes.indexOf(b);a.P.booking.analysisModes.splice(b,1)};a.isSaveDisabled=function(){var b=!1;a.P.inError?b=!0:void 0!==a.P.booking.bookingId&&d.hasRole("USER")&&"PENDING"!==a.P.booking.status&&(b=!0);return b}}]);
myApp.controller("BookingCtrl",["$scope","$http","$routeParams","Shared","$filter",function(a,f,g,d,c){C.log("BookingCtrl: "+JSON.stringify(g));a.Shared=d;a.dtPopup={opened:!1};a.openDt=function(){a.dtPopup.opened=!0};a.$on("bookingLoaded",function(e,b){a.bookingDate=new Date(c("date")(b.bookingDate,"mediumDate"))});a.$watch("bookingDate",function(e,b){C.log("new: "+e+" :: old: "+b);e!==b&&(a.P.booking.bookingDate=c("date")(e,"mediumDate"),a.getSlots(a.P.booking.bookingDate))});a.slotNoToTime=function(a){var b=
0===a%2?"00":"30";return("00"+Math.floor(.5*a)).slice(-2)+":"+b};a.timeToSlotNo=function(a){a=a.replace(/:30/i,":50").replace(/:/i,".");return 2*parseFloat(a)};a.checkOverlap=function(c,b){var d=!1;if(void 0===a.Slots)return!1;for(var f=0;f<a.Slots.length;f++){var d=a.Slots[f],g=a.timeToSlotNo(d.startTime),l=a.timeToSlotNo(d.endTime);if(d=!(b<=g||c>=l)){C.log("checkOverlap: t1="+g+". t2="+l);break}}C.log("checkOverlap: st="+c+". et="+b+". overlaps="+d);return a.P.inError=d};a.handleSliderChange=function(c,
b,d){C.log("Slider value: "+b+". HighValue: "+d);a.overlaps=a.checkOverlap(b,d);a.P.booking.startTime=a.slotNoToTime(b);a.P.booking.endTime=a.slotNoToTime(d);C.log("booking:: "+JSON.stringify(a.P.booking))};a.slider={minValue:16,maxValue:16,options:{showTicks:!0,floor:16,ceil:36,step:1,onChange:a.handleSliderChange,translate:function(c,b,d){return a.slotNoToTime(c)}}};a.getSlots=function(c){void 0!==c&&(C.log("Fetching slots for "+c),f.get("./Bookings/getSlotsForDate.a?date="+c).success(function(b,
c,d,e){"OK"===b.Status?(a.Slots=b.Payload,void 0===a.Slots&&(a.Slots=[])):a.setStatus(b.Payload)}).error(function(b,c,d,e){a.setStatus(b.Payload)}))}}]);myApp.controller("InvoiceCtrl",["$scope","$http","$location","$routeParams","Shared",function(a,f,g,d,c){a.Shared=c;C.log("InvoiceCtrl ...");a.I={};f.get("./Bookings/getInvoice.a?bid="+d.bid).success(function(c,b,d,f){"OK"===c.Status?a.I=c.Payload:a.setStatus(c.Payload)}).error(function(c,b,d,f){a.setStatus(c.Payload)})}]);
